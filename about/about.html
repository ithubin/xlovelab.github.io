{% extends "base/base.html" %}
{% load staticfiles %}
{% block head %}
    <script src="{% static "application/bower_components/d3/d3.js" %}" type="text/javascript"></script>

    <style>

    </style>
{% endblock %}

{% block content %}
    <div id="template-default">
        <div class="container">
            <div class="row">
                <div class="col-xs-12">
                    <div class="page-header">
                        <h1><a href="/application/">关于我们</a></h1>
                    </div>
                </div>
            </div>
            <div class="row" id="us">
            </div>
        </div>
    </div>
{% endblock %}

{% block tail %}
    <script type="text/javascript">
        $('a.btn').each(function (data) {
            $(this).addClass(BTN_CLASS[parseInt(5 * Math.random())]);
        });

        var width = $('#us').width();
        var height = width * 0.618;

        var svg = d3.select("#us").append("svg")
                .attr("width", width)
                .attr("height", height);

        d3.json("/static/application/x/data/china.json", function (error, root) {
            if (error) {
                return console.error(error);
            }

            // create a first guess for the projection
            var center = d3.geo.centroid(root);
            var scale = 150;
            var offset = [width / 2, height / 2];
            var projection = d3.geo.mercator().scale(scale).center(center).translate(offset);

            // create the path
            var path = d3.geo.path().projection(projection);

            // using the path determine the bounds of the current map and use
            // these to determine better values for the scale and translation
            var bounds = path.bounds(root);
            var hscale = scale * width / (bounds[1][0] - bounds[0][0]);
            var vscale = scale * height / (bounds[1][1] - bounds[0][1]);
            scale = (hscale < vscale) ? hscale : vscale;
            offset = [width - (bounds[0][0] + bounds[1][0]) / 2, height - (bounds[0][1] + bounds[1][1]) / 2];

            // new projection
            // center = [103.46936605656265, 36.64103213524577]
            projection = d3.geo.mercator().center(center).scale(scale * 0.9).translate(offset);

            path = path.projection(projection);

            var china = svg.append("g");

            var colorDefault = "#ccc";
            var getColorHover = d3.scale.category20();

            var provinces = china.selectAll("path")
                    .data(root.features)
                    .enter()
                    .append("path")
                    .attr("class", "province")
                    .attr("fill", colorDefault)
                    .attr("stroke", "#fff")
                    .attr("stroke-width", 2)
                    .attr("d", path)
                    .on("mouseover", function (d, i) {
                        d3.select(this).attr("fill", getColorHover(i));
                    })
                    .on("mouseout", function (d, i) {
                        d3.select(this).attr("fill", colorDefault);
                    });

            d3.json("/static/application/x/data/team.json", function (error, team) {

                var defs = svg.append("defs");

                svg.selectAll(".direction")
                        .data(team.people)
                        .enter()
                        .append("line")
                        .attr("fill", function (d, i) {
                            return getColorHover(i);
                        })
                        .attr("stroke", function (d, i) {
                            return getColorHover(i);
                        })
                        .attr("stroke-dasharray", '0.5% 0.5%')
                        .attr("stroke-width", '0.2%')
                        .attr("class", "direction")
                        .attr("x1", function (d) {
                            return projection([d.log, d.lat])[0];
                        })
                        .attr("y1", function (d) {
                            return projection([d.log, d.lat])[1];
                        })
                        .attr("x2", function (d) {
                            return projection([team.log, team.lat])[0];
                        })
                        .attr("y2", function (d) {
                            return projection([team.log, team.lat])[1];
                        });

                svg.selectAll(".link")
                        .data(team.people)
                        .enter()
                        .append("line")
                        .attr("fill", function (d, i) {
                            return getColorHover(i);
                        })
                        .attr("stroke", function (d, i) {
                            return getColorHover(i);
                        })
                        .attr("stroke-width", '0.3%')
                        .attr("class", "direction")
                        .attr("x1", function (d) {
                            return projection([d.xlog, d.xlat])[0];
                        })
                        .attr("y1", function (d) {
                            return projection([d.xlog, d.xlat])[1];
                        })
                        .attr("x2", function (d) {
                            return projection([d.log, d.lat])[0];
                        })
                        .attr("y2", function (d) {
                            return projection([d.log, d.lat])[1];
                        });

                var location = svg.selectAll(".location")
                        .data(team.people)
                        .enter()
                        .append("g")
                        .attr("class", "location")
                        .attr("transform", function (d) {
                            var coor = projection([d.log, d.lat]);
                            return "translate(" + coor[0] + "," + coor[1] + ")";
                        });

                location.append("circle")
                        .attr("r", '0.5%')
                        .attr("fill", function (d, i) {
                            return getColorHover(i);
                        });

                location.append("circle")
                        .attr("cx", function (d) {
                            var coor = projection([d.log, d.lat]);
                            var xcoor = projection([d.xlog, d.xlat]);
                            return xcoor[0] - coor[0];
                        })
                        .attr("cy", function (d) {
                            var coor = projection([d.log, d.lat]);
                            var xcoor = projection([d.xlog, d.xlat]);
                            return xcoor[1] - coor[1];
                        })
                        .attr("r", '5%')
                        .attr("stroke", function (d, i) {
                            return getColorHover(i);
                        })
                        .attr("stroke-width", '0.4%')
                        .attr("fill", function (d, i) {

                            defs.append('pattern')
                                    .attr('id', d.img)
                                    .attr('width', '100%')
                                    .attr('height', '100%')
                                    .attr('viewBox', '0 0 ' + d.w + ' ' + d.h)
                                    .append("image")
                                    .attr("xlink:href", d.img)
                                    .attr('width', d.w)
                                    .attr('height', d.h);

                            return 'url(#' + d.img + ')';
                        })
                        .on("mouseover", function (d, i) {
                            d3.select(this).attr("stroke-width", 0);
                        })
                        .on("mouseout", function (d, i) {
                            d3.select(this).attr("stroke", getColorHover(i)).attr("stroke-width", '0.4%');
                        });

                location.append("text")
                        .attr("x", function (d, i) {
                            return projection([d.xlog, d.xlat])[0] - projection([d.log, d.lat])[0]
                        })
                        .attr("y", function (d, i) {
                            return projection([d.xlog, d.xlat])[1] - projection([d.log, d.lat])[1] + 90
                        })
                        .attr('style', 'font-size:1.372em; font-weight:bold')
                        .attr('text-anchor', 'middle')
                        .attr('alignment-baseline', 'middle')
                        .text(function (d, i) {
                            return d.name + ' • ' + d.title;
                        });

                {#                t.append("tspan")#}
                {#                        .attr("x", function (d, i) {#}
                {#                            return projection([d.xlog, d.xlat])[0] - projection([d.log, d.lat])[0] + 60#}
                {#                        })#}
                {#                        .attr("dy", 0)#}
                {#                        .attr('style', 'font-size:2em')#}
                {#                        .text(function (d, i) {#}
                {#                            return d.name;#}
                {#                        });#}
                {##}
                {#                t.append("tspan")#}
                {#                        .attr("x", function (d, i) {#}
                {#                            return projection([d.xlog, d.xlat])[0] - projection([d.log, d.lat])[0] + 60#}
                {#                        })#}
                {#                        .attr("dy", '1.372em')#}
                {#                        .attr('style', 'font-size:1.618em')#}
                {#                        .text(function (d, i) {#}
                {#                            return d.title;#}
                {#                        });#}

                defs.append("marker")
                        .attr("id", "arrow")
                        .attr("markerUnits", "strokeWidth")
                        .attr("markerWidth", "12")
                        .attr("markerHeight", "12")
                        .attr("viewBox", "0 0 12 12")
                        .attr("refX", "6")
                        .attr("refY", "6")
                        .attr("orient", "auto")
                        .append("path")
                        .attr("d", "M2,2 L10,6 L2,10 L6,6 L2,2")
                        .attr("fill", '#00ffff');

                svg.append("line")
                        .attr("fill", '#000000')
                        .attr("stroke", '#00ffff')
                        .attr("stroke-width", '0.3%')
                        .attr("class", "arrow")
                        .attr("x1", projection([team.xlog, team.xlat])[0])
                        .attr("y1", projection([team.xlog, team.xlat])[1])
                        .attr("x2", projection([team.log, team.lat])[0] - 18)
                        .attr("y2", projection([team.log, team.lat])[1] - 12)
                        .attr('marker-end', 'url(#arrow)');

                var logo = svg.append("g")
                        .attr("transform", "translate(" + projection([team.log, team.lat])[0] + "," + projection([team.log, team.lat])[1] + ")");

                logo.append("circle")
                        .attr("r", '0.8%')
                        .attr("fill", '#00ffff');

                defs.append('pattern')
                        .attr('id', team.img)
                        .attr('width', '100%')
                        .attr('height', '100%')
                        .attr('viewBox', '0 0 ' + team.w + ' ' + team.h)
                        .append("image")
                        .attr("xlink:href", team.img)
                        .attr('width', team.w)
                        .attr('height', team.h);

                logo.append("circle")
                        .attr("cx", projection([team.xlog, team.xlat])[0] - projection([team.log, team.lat])[0])
                        .attr("cy", projection([team.xlog, team.xlat])[1] - projection([team.log, team.lat])[1])
                        .attr("r", '8%')
                        .attr("stroke", '#00ffff')
                        .attr("stroke-width", '0.4%')
                        .attr("fill", 'url(#' + team.img + ')')
                        .on("mouseover", function () {
                            d3.select(this).attr("stroke-width", 0);
                        })
                        .on("mouseout", function () {
                            d3.select(this).attr("stroke-width", '0.4%');
                        });

                var text = logo.append("text")
                        .attr("x", projection([team.xlog, team.xlat])[0] - projection([team.log, team.lat])[0])
                        .attr("y", projection([team.xlog, team.xlat])[1] - projection([team.log, team.lat])[1] - 120)
                        .attr('style', 'font-size:2.4em; font-weight:bold')
                        .attr('text-anchor', 'middle')
                        .attr('alignment-baseline', 'middle')
                        .text(team.name + ' • ' + team.title);

            });
        });

    </script>
{% endblock %}